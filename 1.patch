From 7d1718e66c551119e9ae0076661411adaaf5d5f7 Mon Sep 17 00:00:00 2001
From: andrej12333 <farina.andrej@gmail.com>
Date: Sun, 1 Jul 2018 13:47:26 +0000
Subject: [PATCH] no perf profiles

---
 manifest.xml         |  9 -----
 power/Power.cpp      | 16 ---------
 power/Power.h        |  9 +----
 power/power-8937.c   | 84 --------------------------------------------
 power/power-common.h |  8 -----
 power/power-helper.c |  3 --
 6 files changed, 1 insertion(+), 128 deletions(-)

diff --git a/power/Power.cpp b/power/Power.cpp
index 5d68ae1f..9d9cd9cc 100644
--- a/power/Power.cpp
+++ b/power/Power.cpp
@@ -43,7 +43,6 @@ using ::android::hardware::power::V1_0::Status;
 using ::android::hardware::hidl_vec;
 using ::android::hardware::Return;
 using ::android::hardware::Void;
-using ::android::hardware::power::V1_0::Feature;
 
 Power::Power() {
     power_init();
@@ -128,13 +127,6 @@ Return<void> Power::getPlatformLowPowerStats(getPlatformLowPowerStats_cb _hidl_c
     return Void();
 }
 
-Return<int32_t> Power::getFeature(LineageFeature feature)  {
-    if (feature == LineageFeature::SUPPORTED_PROFILES) {
-        return get_number_of_profiles();
-    }
-    return -1;
-}
-
 status_t Power::registerAsSystemService() {
     status_t ret = 0;
 
@@ -146,14 +138,6 @@ status_t Power::registerAsSystemService() {
         ALOGI("Successfully registered IPower");
     }
 
-    ret = ILineagePower::registerAsService();
-    if (ret != 0) {
-        ALOGE("Failed to register ILineagePower (%d)", ret);
-        goto fail;
-    } else {
-        ALOGI("Successfully registered ILineagePower");
-    }
-
 fail:
     return ret;
 }
diff --git a/power/Power.h b/power/Power.h
index 6cf49304..302e8e66 100644
--- a/power/Power.h
+++ b/power/Power.h
@@ -19,7 +19,6 @@
 #define ANDROID_HARDWARE_POWER_V1_0_POWER_H
 
 #include <android/hardware/power/1.0/IPower.h>
-#include <vendor/lineage/power/1.0/ILineagePower.h>
 #include <hidl/MQDescriptor.h>
 #include <hidl/Status.h>
 #include <hardware/power.h>
@@ -33,12 +32,10 @@ namespace implementation {
 using ::android::hardware::power::V1_0::Feature;
 using ::android::hardware::power::V1_0::PowerHint;
 using ::android::hardware::power::V1_0::IPower;
-using ::vendor::lineage::power::V1_0::ILineagePower;
-using ::vendor::lineage::power::V1_0::LineageFeature;
 using ::android::hardware::Return;
 using ::android::hardware::Void;
 
-struct Power : public IPower, public ILineagePower {
+struct Power : public IPower {
     // Methods from ::android::hardware::power::V1_0::IPower follow.
 
     Power();
@@ -48,10 +45,6 @@ struct Power : public IPower, public ILineagePower {
     Return<void> powerHint(PowerHint hint, int32_t data) override;
     Return<void> setFeature(Feature feature, bool activate) override;
     Return<void> getPlatformLowPowerStats(getPlatformLowPowerStats_cb _hidl_cb) override;
-
-    // Methods from ::vendor::lineage::power::V1_0::ILineagePower follow.
-    Return<int32_t> getFeature(LineageFeature feature) override;
-
     // Methods from ::android::hidl::base::V1_0::IBase follow.
 
 };
diff --git a/power/power-8937.c b/power/power-8937.c
index 87a71dba..c0b107ea 100644
--- a/power/power-8937.c
+++ b/power/power-8937.c
@@ -54,79 +54,6 @@ static int video_encode_hint_sent;
 
 extern void interaction(int duration, int num_args, int opt_list[]);
 
-static int current_power_profile = PROFILE_BALANCED;
-
-static int profile_high_performance[] = {
-    SCHED_BOOST_ON_V3, 0x1,
-    ALL_CPUS_PWR_CLPS_DIS_V3, 0x1,
-    CPUS_ONLINE_MIN_BIG, 0x4,
-    MIN_FREQ_BIG_CORE_0, 0xFFF,
-    MIN_FREQ_LITTLE_CORE_0, 0xFFF,
-    GPU_MIN_PWRLVL_BOOST, 0x1,
-    SCHED_PREFER_IDLE_DIS_V3, 0x1,
-    SCHED_SMALL_TASK_DIS, 0x1,
-    SCHED_IDLE_NR_RUN_DIS, 0x1,
-    SCHED_IDLE_LOAD_DIS, 0x1,
-};
-
-static int profile_power_save[] = {
-    CPUS_ONLINE_MAX_LIMIT_BIG, 0x1,
-    MAX_FREQ_BIG_CORE_0, 0x3bf,
-    MAX_FREQ_LITTLE_CORE_0, 0x300,
-};
-
-static int profile_bias_power[] = {
-    MAX_FREQ_BIG_CORE_0, 0x4B0,
-    MAX_FREQ_LITTLE_CORE_0, 0x300,
-};
-
-static int profile_bias_performance[] = {
-    CPUS_ONLINE_MAX_LIMIT_BIG, 0x4,
-    MIN_FREQ_BIG_CORE_0, 0x540,
-};
-
-#ifdef INTERACTION_BOOST
-int get_number_of_profiles() {
-    return 5;
-}
-#endif
-
-static void set_power_profile(int profile) {
-
-    if (profile == current_power_profile)
-        return;
-
-    ALOGV("%s: profile=%d", __func__, profile);
-
-    if (current_power_profile != PROFILE_BALANCED) {
-        undo_hint_action(DEFAULT_PROFILE_HINT_ID);
-        ALOGV("%s: hint undone", __func__);
-    }
-
-    if (profile == PROFILE_HIGH_PERFORMANCE) {
-        perform_hint_action(DEFAULT_PROFILE_HINT_ID, profile_high_performance,
-                ARRAY_SIZE(profile_high_performance));
-        ALOGD("%s: set performance mode", __func__);
-
-    } else if (profile == PROFILE_POWER_SAVE) {
-        perform_hint_action(DEFAULT_PROFILE_HINT_ID, profile_power_save,
-                ARRAY_SIZE(profile_power_save));
-        ALOGD("%s: set powersave", __func__);
-
-    } else if (profile == PROFILE_BIAS_POWER) {
-        perform_hint_action(DEFAULT_PROFILE_HINT_ID, profile_bias_power,
-                ARRAY_SIZE(profile_bias_power));
-        ALOGD("%s: Set bias power mode", __func__);
-
-    } else if (profile == PROFILE_BIAS_PERFORMANCE) {
-        perform_hint_action(DEFAULT_PROFILE_HINT_ID, profile_bias_performance,
-                ARRAY_SIZE(profile_bias_performance));
-        ALOGD("%s: Set bias perf mode", __func__);
-    }
-
-    current_power_profile = profile;
-}
-
 static void process_video_encode_hint(void *metadata)
 {
     char governor[80];
@@ -200,17 +127,6 @@ int power_hint_override(power_hint_t hint, void *data)
         SCHED_BOOST_ON_V3, 0x1,
     };
 
-    if (hint == POWER_HINT_SET_PROFILE) {
-        set_power_profile(*(int32_t *)data);
-        return HINT_HANDLED;
-    }
-
-    // Skip other hints in high/low power mode
-    if (current_power_profile == PROFILE_POWER_SAVE ||
-            current_power_profile == PROFILE_HIGH_PERFORMANCE) {
-        return HINT_HANDLED;
-    }
-
     switch (hint) {
     	case POWER_HINT_INTERACTION:
             duration = 500;
diff --git a/power/power-common.h b/power/power-common.h
index 601eb42d..adce030d 100644
--- a/power/power-common.h
+++ b/power/power-common.h
@@ -51,12 +51,4 @@ enum CPU_GOV_CHECK {
     CPU3 = 3
 };
 
-enum {
-    PROFILE_POWER_SAVE = 0,
-    PROFILE_BALANCED,
-    PROFILE_HIGH_PERFORMANCE,
-    PROFILE_BIAS_POWER,
-    PROFILE_BIAS_PERFORMANCE
-};
-
 #define UNUSED(x) UNUSED_ ## x __attribute__((__unused__))
diff --git a/power/power-helper.c b/power/power-helper.c
index d78cea51..52e9e81c 100644
--- a/power/power-helper.c
+++ b/power/power-helper.c
@@ -277,9 +277,6 @@ void power_hint(power_hint_t hint, void *data)
         case POWER_HINT_VIDEO_DECODE:
             process_video_decode_hint(data);
         break;
-        case POWER_HINT_SET_PROFILE:
-            ALOGI("set profile power hint not handled in power_hint_override");
-        break;
         default:
         break;
     }
